{"version":3,"file":"associate-with-form.js","sourceRoot":"","sources":["../src/form-association/associate-with-form.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,oBAAoB,GAAG,MAAM,aAAa,CAAC;AAGpD,MAAM,KAAK,GAAG,CAAC,UAAU,EAAE,UAAU,EAAE,OAAO,CAAC,CAAC;AAGhD,MAAM,qCAAsC,SAAQ,WAAW;IAC9D,oBAAoB;QACnB,IAAI,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,cAAc,CAAC,CAAC,CAAC;IAC/C,CAAC;CACD;AAED,MAAM,CAAC,cAAc,CAAC,MAAM,CAC3B,gCAAgC,EAChC,qCAAqC,CACrC,CAAC;AAEF,SAAS,mCAAmC,CAC3C,WAA6B,EAC7B,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,YAAY,EAAgB;IAEjD,WAAW,CAAC,KAAK,CAAC,OAAO,GAAG,MAAM,CAAC;IACnC,IAAI,IAAI,EAAE;QACT,WAAW,CAAC,YAAY,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;KACvC;IACD,IAAI,IAAI,EAAE;QACT,WAAW,CAAC,YAAY,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;KACvC;IACD,WAAW,CAAC,YAAY,GAAG,YAAY,CAAC;AACzC,CAAC;AAED,SAAS,8BAA8B,CACtC,WAA4B,EAC5B,UAAmC;IAEnC,MAAM,WAAW,GAAG,QAAQ,CAAC,aAAa,CAAC,UAAU,CAAqB,CAAC;IAC3E,WAAW,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;IACrC,OAAO,WAAW,CAAC;AACpB,CAAC;AAED,SAAS,wCAAwC,CAChD,UAAwC,EACxC,KAAa,EACb,iBAAiB,GAAG,EAAE;IAEtB,IAAI,CAAC,UAAU,EAAE;QAChB,OAAO;KACP;IACD,UAAU,CAAC,KAAK,GAAG,KAAK,CAAC;IACzB,UAAU,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,CAAC;AACjD,CAAC;AAED,SAAS,gBAAgB,CACxB,YAAe,EACf,mBAAqC,EACrC,WAA6B;IAE7B,OAAO,GAAG,EAAE;;QACX,YAAY,CAAC,KAAK,GAAG,mBAAmB,CAAC,KAAK;YAC7C,MAAA,WAAW,aAAX,WAAW,uBAAX,WAAW,CAAE,YAAY,mCAAI,EAAE,CAAC;QACjC,wCAAwC,CACvC,WAAW,EACX,YAAY,CAAC,KAAK,EAClB,mBAAmB,CAAC,iBAAiB,CACrC,CAAC;IACH,CAAC,CAAC;AACH,CAAC;AAED,SAAS,mBAAmB,CAAC,YAA8B;IAC1D,YAAY,CAAC,gBAAgB,CAAC,SAAS,EAAE,CAAC,KAAY,EAAE,EAAE;QACzD,KAAK,CAAC,eAAe,EAAE,CAAC;QACxB,KAAK,CAAC,cAAc,EAAE,CAAC;IACxB,CAAC,CAAC,CAAC;AACJ,CAAC;AAED,SAAS,6BAA6B,CACrC,YAAe,EACf,mBAAqC,EACrC,WAA6B;IAE7B,MAAM,UAAU,GAAG,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;IACvC,UAAU,CAAC,OAAO,CAAC,CAAC,SAAS,EAAE,EAAE;QAChC,YAAY,CAAC,gBAAgB,CAAC,SAAS,EAAE,GAAG,EAAE;YAC7C,wCAAwC,CACvC,WAAW,EACX,YAAY,CAAC,KAAK,EAClB,mBAAmB,CAAC,iBAAiB,CACrC,CAAC;QACH,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;AACJ,CAAC;AAED,SAAS,iCAAiC,CACzC,YAAe,EACf,qBAAiC;IAEjC,MAAM,qBAAqB,GAAG,QAAQ,CAAC,aAAa,CACnD,gCAAgC,CACS,CAAC;IAC3C,qBAAqB,CAAC,gBAAgB,CAAC,cAAc,EAAE,GAAG,EAAE;QAC3D,qBAAqB,EAAE,CAAC;IACzB,CAAC,CAAC,CAAC;IACH,YAAY,CAAC,WAAW,CAAC,qBAAqB,CAAC,CAAC;AACjD,CAAC;AAED,SAAS,2BAA2B,CACnC,WAA6B,EAC7B,WAA4B,EAC5B,gBAA4B;IAE5B,OAAO,GAAG,EAAE;QACX,WAAW,CAAC,MAAM,EAAE,CAAC;QACrB,WAAW,CAAC,mBAAmB,CAAC,OAAO,EAAE,gBAAgB,CAAC,CAAC;IAC5D,CAAC,CAAC;AACH,CAAC;AAED,MAAM,UAAU,iBAAiB,CAChC,kBAAgC,EAChC,mBAAqC;IAErC,MAAM,WAAW,GAAG,oBAAoB,CAAC,kBAAkB,CAAC,CAAC;IAE7D,IAAI,CAAC,WAAW,EAAE;QACjB,OAAO;KACP;IAED,MAAM,WAAW,GAAG,8BAA8B,CACjD,WAAW,EACX,mBAAmB,CAAC,QAAQ,CAC5B,CAAC;IACF,mCAAmC,CAAC,WAAW,EAAE,kBAAkB,CAAC,CAAC;IACrE,mBAAmB,CAAC,WAAW,CAAC,CAAC;IAEjC,MAAM,gBAAgB,GAAG,gBAAgB,CACxC,kBAAkB,EAClB,mBAAmB,EACnB,WAAW,CACX,CAAC;IAEF,MAAM,qBAAqB,GAAG,2BAA2B,CACxD,WAAW,EACX,WAAW,EACX,gBAAgB,CAChB,CAAC;IAEF,wCAAwC,CACvC,WAAW,EACX,kBAAkB,CAAC,KAAK,EACxB,mBAAmB,CAAC,iBAAiB,CACrC,CAAC;IAEF,WAAW,CAAC,gBAAgB,CAAC,OAAO,EAAE,gBAAgB,CAAC,CAAC;IAExD,iCAAiC,CAAC,kBAAkB,EAAE,qBAAqB,CAAC,CAAC;IAE7E,6BAA6B,CAC5B,kBAAkB,EAClB,mBAAmB,EACnB,WAAW,CACX,CAAC;AACH,CAAC","sourcesContent":["import { getFormByIdOrClosest, } from './common.js';\nimport type { InputElement } from './common.js';\n\nconst types = ['checkbox', 'textarea', 'input'];\nexport type HiddenInputType = typeof types;\n\nclass FormAssociationDisconnectionComponent extends HTMLElement {\n\tdisconnectedCallback() {\n\t\tthis.dispatchEvent(new Event('disconnected'));\n\t}\n}\n\nwindow.customElements.define(\n\t'form-association-disconnection',\n\tFormAssociationDisconnectionComponent\n);\n\nfunction setHiddenInputInitialValuesAndStyle(\n\thiddenInput: HTMLInputElement,\n\t{ name, type, value: initialValue }: InputElement\n) {\n\thiddenInput.style.display = 'none';\n\tif (name) {\n\t\thiddenInput.setAttribute('name', name);\n\t}\n\tif (type) {\n\t\thiddenInput.setAttribute('type', type);\n\t}\n\thiddenInput.defaultValue = initialValue;\n}\n\nfunction appendHiddenInputToHostingForm(\n\thostingForm: HTMLFormElement,\n\thiddenType: HiddenInputType[number]\n) {\n\tconst hiddenInput = document.createElement(hiddenType) as HTMLInputElement;\n\thostingForm.appendChild(hiddenInput);\n\treturn hiddenInput;\n}\n\nfunction setInternalValueAndValidityInHiddenInput(\n\tinputField: HTMLInputElement | undefined,\n\tvalue: string,\n\tvalidationMessage = ''\n) {\n\tif (!inputField) {\n\t\treturn;\n\t}\n\tinputField.value = value;\n\tinputField.setCustomValidity(validationMessage);\n}\n\nfunction resetFormFactory<T extends InputElement>(\n\tinputElement: T,\n\tinternalFormElement: HTMLInputElement,\n\thiddenInput: HTMLInputElement\n) {\n\treturn () => {\n\t\tinputElement.value = internalFormElement.value =\n\t\t\thiddenInput?.defaultValue ?? '';\n\t\tsetInternalValueAndValidityInHiddenInput(\n\t\t\thiddenInput,\n\t\t\tinputElement.value,\n\t\t\tinternalFormElement.validationMessage\n\t\t);\n\t};\n}\n\nfunction suspendInvalidEvent(inputElement: HTMLInputElement) {\n\tinputElement.addEventListener('invalid', (event: Event) => {\n\t\tevent.stopPropagation();\n\t\tevent.preventDefault();\n\t});\n}\n\nfunction syncValueAndValidityOnChanges<T extends InputElement>(\n\tinputElement: T,\n\tinternalFormElement: HTMLInputElement,\n\thiddenInput: HTMLInputElement\n) {\n\tconst eventNames = ['input', 'change'];\n\teventNames.forEach((eventName) => {\n\t\tinputElement.addEventListener(eventName, () => {\n\t\t\tsetInternalValueAndValidityInHiddenInput(\n\t\t\t\thiddenInput,\n\t\t\t\tinputElement.value,\n\t\t\t\tinternalFormElement.validationMessage\n\t\t\t);\n\t\t});\n\t});\n}\n\nfunction appendDisconnectionCleanupElement<T extends InputElement>(\n\tinputElement: T,\n\tdisconnectionCallback: () => void\n) {\n\tconst removeListenerElement = document.createElement(\n\t\t'form-association-disconnection'\n\t) as FormAssociationDisconnectionComponent;\n\tremoveListenerElement.addEventListener('disconnected', () => {\n\t\tdisconnectionCallback();\n\t});\n\tinputElement.appendChild(removeListenerElement);\n}\n\nfunction associateFormCleanupFactory(\n\thiddenInput: HTMLInputElement,\n\thostingForm: HTMLFormElement,\n\tresetFormHandler: () => void\n) {\n\treturn () => {\n\t\thiddenInput.remove();\n\t\thostingForm.removeEventListener('reset', resetFormHandler);\n\t};\n}\n\nexport function associateWithForm(\n\tcustomInputElement: InputElement,\n\tinternalFormElement: HTMLInputElement\n): void {\n\tconst hostingForm = getFormByIdOrClosest(customInputElement);\n\n\tif (!hostingForm) {\n\t\treturn;\n\t}\n\n\tconst hiddenInput = appendHiddenInputToHostingForm(\n\t\thostingForm,\n\t\tinternalFormElement.nodeName\n\t);\n\tsetHiddenInputInitialValuesAndStyle(hiddenInput, customInputElement);\n\tsuspendInvalidEvent(hiddenInput);\n\n\tconst resetFormHandler = resetFormFactory(\n\t\tcustomInputElement,\n\t\tinternalFormElement,\n\t\thiddenInput\n\t);\n\n\tconst disconnectionCallback = associateFormCleanupFactory(\n\t\thiddenInput,\n\t\thostingForm,\n\t\tresetFormHandler\n\t);\n\n\tsetInternalValueAndValidityInHiddenInput(\n\t\thiddenInput,\n\t\tcustomInputElement.value,\n\t\tinternalFormElement.validationMessage\n\t);\n\n\thostingForm.addEventListener('reset', resetFormHandler);\n\n\tappendDisconnectionCleanupElement(customInputElement, disconnectionCallback);\n\n\tsyncValueAndValidityOnChanges(\n\t\tcustomInputElement,\n\t\tinternalFormElement,\n\t\thiddenInput\n\t);\n}\n"]}