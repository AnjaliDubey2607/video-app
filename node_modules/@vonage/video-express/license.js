const { execSync } = require('child_process');
const { readFileSync } = require('fs');
const flyTemplate = require('fly-template');
const { version } = require('./package.json');

const licenseTemplate = readFileSync('./LICENSE', 'utf8');
const render = flyTemplate(licenseTemplate);

const getHash = () => {
  if (process.env.IS_HEROKU) {
    // Heroku does not keep .git files
    return process.env.SOURCE_VERSION;
  }
  return execSync('git rev-parse --short -q HEAD')
    .toString()
    .trim();
};

const sha = getHash();

const license = render({
  sha,
  version,
});
module.exports = license;
